<div class="admin-container">
  <!-- HEADER -->
  <header class="admin-header">
    <div class="header-left">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
      </div>
      <div>
        <h1>Panel de Administración</h1>
        <p class="subtitle">Sistema Bibliométrico</p>
      </div>
    </div>

    <div class="header-right">
      <button class="btn-secondary" (click)="goToRegularDashboard()">Ver Dashboard Normal</button>
      <div class="user-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>{{ currentUser?.nombre }}</span>
        <span class="badge-admin-small">Admin</span>
      </div>
      <button class="btn-logout" (click)="logout()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Salir
      </button>
    </div>
  </header>

  <!-- CONTENT -->
  <div class="admin-content">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab" [class.active]="activeView === 'overview'" (click)="setActiveView('overview')">📊 Vista General</button>
      <button class="tab" [class.active]="activeView === 'users'" (click)="setActiveView('users')">👥 Usuarios</button>
      <button class="tab" [class.active]="activeView === 'activity'" (click)="setActiveView('activity')">📝 Actividad Reciente</button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner-large"></div>
      <p>Cargando datos del panel...</p>
    </div>

    <!-- VISTA GENERAL -->
    <div *ngIf="!loading && activeView === 'overview'" class="overview-section">
      <div class="stats-grid">
        <div class="stat-card card-users">
          <div class="stat-icon">👥</div>
          <div class="stat-content">
            <p class="stat-label">Total Usuarios</p>
            <p class="stat-value">{{ stats.totalUsers }}</p>
          </div>
        </div>
        <div class="stat-card card-thesis">
          <div class="stat-icon">📚</div>
          <div class="stat-content">
            <p class="stat-label">Total Tesis</p>
            <p class="stat-value">{{ stats.totalThesis }}</p>
          </div>
        </div>
        <div class="stat-card card-month">
          <div class="stat-icon">📅</div>
          <div class="stat-content">
            <p class="stat-label">Análisis (Mes)</p>
            <p class="stat-value">{{ stats.totalThisMonth }}</p>
          </div>
        </div>
        <div class="stat-card card-average">
          <div class="stat-icon">⭐</div>
          <div class="stat-content">
            <p class="stat-label">Promedio Calidad</p>
            <p class="stat-value">{{ stats.averageScore.toFixed(1) }}%</p>
          </div>
        </div>
      </div>
      <div class="charts-grid">
        <!-- Gráficos futuros -->
      </div>
    </div>

    <!-- USUARIOS -->
    <div *ngIf="!loading && activeView === 'users'" class="users-section">
      <div class="users-filters">
        <input 
          type="text" 
          class="search-input" 
          placeholder="🔍 Buscar por nombre o email..."
          [(ngModel)]="searchTerm"
          (keyup)="filterUsers()"
        />
        <select class="filter-select" [(ngModel)]="selectedRole" (change)="filterUsers()">
          <option value="">Todos los roles</option>
          <option value="admin">Administradores</option>
          <option value="docente">Docentes</option>
          <option value="investigador">Investigadores</option>
          <option value="user">Usuarios</option>
        </select>
      </div>

      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Universidad</th>
              <th>Estado</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td>{{ user.nombre }}</td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge" [class]="getRoleBadgeClass(user.role)">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>{{ user.universidad || '-' }}</td>
              <td>
                <span class="status-badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                  {{ user.isActive ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>{{ formatDate(user.createdAt!) }}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-icon btn-edit" (click)="openEditModal(user)" title="Editar">✏️</button>
                  <button 
                    class="btn-icon" 
                    [class.btn-deactivate]="user.isActive"
                    [class.btn-activate]="!user.isActive"
                    (click)="toggleUserStatus(user)" 
                    [title]="user.isActive ? 'Desactivar' : 'Activar'">
                    {{ user.isActive ? '🚫' : '✅' }}
                  </button>
                  <button class="btn-icon btn-delete" (click)="openDeleteModal(user)" title="Eliminar">🗑️</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="filteredUsers.length === 0" class="no-results">
          <p>No se encontraron usuarios con los filtros aplicados.</p>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR USUARIO -->
    <div class="modal-overlay" *ngIf="showEditModal">
      <div class="edit-user-modal modal-content">
        <div class="modal-header">
          <h2>Editar Usuario</h2>
          <button class="btn-close" (click)="closeEditModal()">✖</button>
        </div>
        <div class="modal-body">
          <form *ngIf="editingUser">
            <div class="form-group">
              <label for="nombre">Nombre</label>
              <input id="nombre" type="text" [(ngModel)]="editingUser.nombre" name="nombre" required />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input id="email" type="email" [(ngModel)]="editingUser.email" name="email" required />
            </div>
            <div class="form-group">
              <label for="role">Rol</label>
              <select id="role" [(ngModel)]="editingUser.role" name="role">
                <option value="admin">Administrador</option>
                <option value="docente">Docente</option>
                <option value="investigador">Investigador</option>
                <option value="user">Usuario</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
          <button class="btn-primary" [disabled]="!editingUser" (click)="saveUser()">Guardar</button>
        </div>
      </div>
    </div>

    <!-- MODAL ELIMINAR USUARIO -->
    <div class="modal-overlay" *ngIf="showDeleteModal">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <h2>Confirmar Eliminación</h2>
          <button class="btn-close" (click)="closeDeleteModal()">✖</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar al usuario <strong>{{ deletingUser?.nombre }}</strong>?</p>
          <p class="warning-text">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
          <button class="btn-danger" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>

    <!-- ACTIVIDAD RECIENTE -->
    <div *ngIf="!loading && activeView === 'activity'" class="activity-section">
      <h3>Actividad Reciente en el Sistema</h3>
      <div class="activity-list">
        <div *ngFor="let activity of recentActivities" class="activity-item">
          <div class="activity-icon">📌</div>
          <div class="activity-content">
            <p class="activity-text">{{ activity.description }}</p>
            <p class="activity-time">{{ formatDate(activity.createdAt) }}</p>
          </div>
        </div>
        <div *ngIf="recentActivities.length === 0" class="no-activity">
          <p>No hay actividad reciente para mostrar.</p>
        </div>
      </div>
    </div>
  </div>
</div>
